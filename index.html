<!DOCTYPE html>
<head>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8" />
<script charset="utf-8" src="exhibit/api/exhibit-api.js?bundle=false" type="text/javascript"></script>
<script charset="utf-8" src="exhibit/api/andListfacet.js" type="text/javascript"></script>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script type="text/javascript">

var force;
var svg;

var width = 640;
var height = 640;

var color = d3.scale.category10();
var init = false;

var link_categories = [
 {"name":"style",
  "color":"#ff7f0e",
  "active":true
 },
 {"name":"topos",
  "color":"#2ca02c",
  "active":true
 },
 {"name":"slwork",
  "color":"#d62728",
  "active":true
 },
 {"name":"cites",
  "color":"#9467bd",
  "active":true
 }
]


function draw() {
      var nodes = getData();
      if (force) {
        force.stop();
      }
      force = d3.layout.force()
        .charge(-1 * height / 5)
        .linkDistance(50)
        .size([width, height]);

      svg = d3.select("svg")
      svg.selectAll(".node").remove();
	  svg.selectAll("line.link").remove();
	  var known_connectors = {}
	  console.log(link_categories);
	  for (n in link_categories) {
		known_connectors[link_categories[n]["name"]] = {};
	  }
	  console.log(known_connectors);
	  var dynamic_links = [];

	
/*	
	  var to_filter = [];
	  for (n in graph.nodes){
		if (graph.nodes[n]["GENRE"] != "chamber: string quartet"){
		  to_filter.push(n);    
		}  
	  }
	  for (n in to_filter){
		index = to_filter[n];
		graph.nodes.splice(index - n,1);
	  }
*/		
	  for (n in nodes){
		for (i in link_categories) {
		  if (link_categories[i].active) {
			  var column = link_categories[i].name;
			  var values = nodes[n][column];
			  for (j in values) {
				var value = values[j];
				console.log(value);
				if (known_connectors[column][value] == undefined) {
					known_connectors[column][value] = nodes.length;
					var new_node = {"label":value,
									"type":column,
									"color":link_categories[i].color,
									"id":nodes.length
					};
					nodes.push(new_node);
				}
				var new_edge = {"source":parseInt(n),
								"target":parseInt(known_connectors[column][value]),
								"value":parseInt(1)        	        	
				};
				console.log(dynamic_links.push(new_edge));
			  }
		  }
		}
	  }
	
	  force
		  .nodes(nodes)
		  .links(dynamic_links);	
      force.start()

	  var link_updates = svg.selectAll("line.link")
		  .data(dynamic_links, function(d) {return d.source.label+"_"+d.target.label});
	  link_updates.exit().remove();
	  var links = link_updates
		.enter().append("line")
		  .attr("class", "link")
		  .style("stroke-width", function(d) { return Math.sqrt(d.value); });
		
	  var node_updates = svg.selectAll(".node")
		.data(nodes, function(d) {return d.label});
	  node_updates.exit().remove();
	  var nodes = node_updates
		.enter().append("g")
		.attr("class", "node")
		.call(force.drag)
		.on("mousedown", function(d) { d.fixed = true; d3.select(this).select("circle").style("stroke", "black").style("stroke-width","4"); })
		.on("dblclick", function(d) { d.fixed = false;d3.select(this).select("circle").style("stroke", "white").style("stroke-width","2") });	
	  nodes.append("circle")
		.attr("r", 6)
		.style("fill", function(d) { return d.color || "#1f77b4"; });	
	  nodes.append("title")
		.attr("dx", 8)
		.attr("dy", ".31em")
		.text(function(d) { return JSON.stringify(d) });	
      nodes.append("text")
        .attr("x", 8)
        .attr("y", ".31em")
        .attr("class", "shadow")
        .text(function(d) { return d.label; });
	  nodes.append("text")
		.attr("dx", 8)
		.attr("dy", ".31em")
		.text(function(d) { return d.label });	

	  force.on("tick", function() {
		svg.selectAll("line.link").attr("x1", function(d) { return d.source.x; })
			 .attr("y1", function(d) { return d.source.y; })
			 .attr("x2", function(d) { return d.target.x; })
			 .attr("y2", function(d) { return d.target.y; });						
		svg.selectAll(".node").attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; }); 	
	  });

}


function getData() {	//Only working with one collection in this tool
	var c = window.exhibit.getDefaultCollection();
	//gets the ids of the facted data
	var items = c.getRestrictedItems()._hash;				
 
	//get the acutal data objects
	var db = window.exhibit.getDatabase()._spo;
	var newDataObject = [];
	//build facted data object
	for (aItem in items){
	  newDataObject.push(db[aItem]);
	}					  
 
	return newDataObject
}

function setup() {
  if (typeof window.exhibit == 'undefined'){
    eTimeout = setTimeout("setup()",250);
  } else {
    console.log("ready")
//    console.log(getData());
    var l_column_pos = $("exhibit-viewPanel").offset();
    var l_column_width = $("exhibit-viewPanel").width();
    $("svg").offset(l_column_pos);
    $("svg").width(l_column_width);
    $(".legend-container").width(l_column_width);
    var c = window.exhibit.getDefaultCollection();
    c.addListener({
        onItemsChanged: function() {
        //console.log(getData());
        //        updateGraph();
          if ($(".networkView").css("display") == "block") {
            draw();
          }
        },
        onRootItemsChanged: function() {
        //console.log(getData());
        //        updateGraph();
          if ($(".networkView").css("display") == "block") {
            draw();
          }
        }
    });
    $("#select-view").on("click","span",function(event){
        console.log($(".exhibit-tileView-body").css("display"));
        if (event.target.id == "select-list") {          
            $(".exhibit-viewPanel").show()
            $(".networkView").hide();
        }
        else if (event.target.id == "select-network") {
            $(".exhibit-viewPanel").hide();
//          $(".networkView").remove();
//     	  $(".exhibit-tileView-body").after("<svg class='networkView' style='display:none; width:620px; height:620px;'></svg>");
            $(".networkView").show();
            draw();
        }
    });
    $(".legend").on("click",function(e){
        console.log(event.target.id);
        for (n in link_categories) {
          if (link_categories[n].name == this.id) {
            link_categories[n].active = !link_categories[n].active;
            console.log(link_categories[n]);
            if (link_categories[n].active) {
                $(this).css("color",link_categories[n].color);
            }
            else {
                $(this).css("color","gray");
            }
          }
        }
        draw();    
    });
  }
}

$(document).ready(function(){
    setup();
});

</script>
  <link rel="exhibit/data" 
       type="application/jsonp"
       href="http://spreadsheets.google.com/feeds/list/0AmC3h3hWs3uTdHJmd2Z0MWlOdDEtNHdLV2UxV1pJbFE/od6/public/basic?alt=json-in-script"
      
       ex:converter="googleSpreadsheets" />

 <link href="music-schema.js" type="application/json" rel="exhibit/data" />



<style type="text/css">
body {font-family: Helvetica, sans-serif;}
ol.exhibit-tileView-body {
	list-style: none;
}

a.exhibit-facet-value-link {font-size:.9em;}
div.programnote {
	font-size:.8em;	
	padding-left:10px;

}

div.programnote a, div.programnote a:visited {
	color:grey; text-decoration: underline;
}
.black, .black a {color:black;}

audio {width:100%;display:block;}

h5 {font-style:normal;
	line-height: 100%;
	margin-bottom:0;
	font-weight:normal;
	border-top: 3px double gray;
}

div.exhibit-collectionView-body {
	width:600px;
}

circle {
  stroke: #fff;
  stroke-width: 1.5px;
}

.link {
  stroke: #999;
  strokw-width:3px;

}
tr.networkView {
  position:absolute;
  top: 48px;
  left: 0px;
}
text {
  pointer-events: none;
  font: 10px sans-serif;
  color:black;
  fill:black;
}

text.shadow {
  stroke: #fff;
  stroke-width: 3px;
  stroke-opacity: .8;
}

/* fixes for Safari scrollbars in Lion and Mountain Lion */

::-webkit-scrollbar {
    width: 7px;
}

::-webkit-scrollbar-track {
  visibility: hidden; 
}

::-webkit-scrollbar-thumb {
    border-radius: 4px;
    background: rgba(0,0,0,0.5);
}

::-webkit-scrollbar:window-inactive {
    visibility: hidden;
}

</style>




</head>
<body>
 

<table style="width:1100px;">
<tr> <td colspan="3" id='select-view' style="vertical-align:top; width:1100px;"> View as <span id='select-list'>List</span> | <span id='select-network'>Network</span> </td> </tr>
<tr class='networkView' style='display:none;'><td colspan='1'> 
<svg style='width:650px; height:650px;'></svg> 
<h5 class="legend-container" style="width:640px;">Drag a node to fix it in space. Double-click to release. 
<p>Legend: 
<span style="color:#1f77b4;">Compositions</span>, 
<span class="legend" style="color:#ff7f0e;" id="style">Style</span>, 
<span class="legend" style="color:#2ca02c;" id="topos">Topoi</span>, 
<span class="legend" style="color:#d62728;" id="slwork">Sounds Like</span>, 
<span class="legend" style="color:#9467bd" id="cites">Cites</span> [click to toggle]</h3> 

</td></tr>
<tr>
<td rowspan="2" style="vertical-align:top;width:640px;">
<ul ex:role="viewPanel">

    <div ex:role="view" ex:showToolbox="true" ex:showSummary="true" ex:orders=".composer" ex:directions="ascending" ex:possibleOrders=".date, .composer" ex:showAll="false" ex:grouped="false" ex:abbreviatedCount="50"></div>
    <div ex:role="lens" ex:onshow="$(this).attr('id', function () { return 'result'+this.getAttribute('ex:itemID');});$(this).find('source').wrap('<audio controls preload=\x22none\x22>');$.expander.defaults.slicePoint = 500;$(this).find('p').expander();" style="margin:5px 0 10px 0;padding-left:10px;"  ><h3 ex:content=".label" style="font-family:serif;font-size:1.5em;"></h3>
    <div class="articlemeta"><b ex:content=".composer"></b> <span ex:content="if(exists(.year), .year, 'Unknown')"></span> </div>

    <source ex:src-subcontent="http://sethsem.uchicago.edu/~spb/1989/{{.mp3}}" type="audio/mpeg">
    <div ex:if-exists=".programnote" class="programnote" id=""> <p ex:content=".programnote" ></p>    </div>
    

    </div>

</ul>


</td>
<td colspan="2">
 <div ex:role="facet" ex:facetLabel="Search All Data" ex:facetClass="TextSearch"></div>
</td></tr>
<tr>
<td style="vertical-align:top;width:200px;">

  


   </div>
	<div ex:role="facet" ex:expression=".composer" ex:scroll="true" ex:showMissing="false" ex:facetLabel="Composer" ex:sortMode="count" ></div>
	 	<div ex:role="facet" ex:expression=".style" ex:scroll="true" ex:showMissing="false" ex:facetLabel="Style" ex:sortMode="count" ></div>	     
	  	<div ex:role="facet" ex:expression=".cites" ex:scroll="true" ex:showMissing="false" ex:facetLabel="Cites" ex:sortMode="count" ></div>	     
	 <div ex:role="facet" ex:expression=".topos" ex:scroll="true" ex:showMissing="false" ex:facetLabel="Topos" ex:sortMode="count" ></div>	   
  
</td>
<td  style="vertical-align:top;width:200px;">
    	<div ex:role="facet" ex:expression=".genre" ex:scroll="true" ex:showMissing="false" ex:facetLabel="Genre" ex:sortMode="count" ></div>   
  
	<div ex:role="facet" ex:expression=".slwork" ex:scroll="true" ex:showMissing="false" ex:facetLabel="Sounds Like (work)" ex:sortMode="count" ></div> 
	
	<div ex:role="facet" ex:expression=".nation" ex:scroll="true" ex:showMissing="false" ex:facetLabel="Composer Nationality" ex:sortMode="count" ></div>
	<div ex:role="facet" ex:expression=".premierenation" ex:scroll="true" ex:showMissing="false" ex:facetLabel="Premiere Location" ex:sortMode="count" ></div>	 	  
	    
		 

</td>
</tr>
</table>



 </body>



</html>
