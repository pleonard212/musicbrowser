<!DOCTYPE html>
<head>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8" />
<script charset="utf-8" src="exhibit/api/exhibit-api.js?bundle=false" type="text/javascript"></script>
<script charset="utf-8" src="exhibit/api/andListfacet.js" type="text/javascript"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="jquery.expander.min.js"></script> 
<script type="text/javascript">

var force;
var svg;

var width = 640;
var height = 640;

var color = d3.scale.category10();
var init = false;

var link_categories = [
 {"name":"style",
  "color":"#ff7f0e",
  "active":true
 },
 {"name":"topos",
  "color":"#2ca02c",
  "active":true
 },
 {"name":"slwork",
  "color":"#d62728",
  "active":true
 },
 {"name":"cites",
  "color":"#9467bd",
  "active":true
 }
]


function draw() {
      var nodes = getData();
      if (force) {
        force.stop();
      }
      force = d3.layout.force()
        .charge(-1 * height / 5)
        .linkDistance(50)
        .size([width, height]);

      svg = d3.select("svg")
      svg.selectAll(".node").remove();
	  svg.selectAll("line.link").remove();
	  var known_connectors = {}
	  console.log(link_categories);
	  for (n in link_categories) {
		known_connectors[link_categories[n]["name"]] = {};
	  }
	  console.log(known_connectors);
	  var dynamic_links = [];

	
/*	
	  var to_filter = [];
	  for (n in graph.nodes){
		if (graph.nodes[n]["GENRE"] != "chamber: string quartet"){
		  to_filter.push(n);    
		}  
	  }
	  for (n in to_filter){
		index = to_filter[n];
		graph.nodes.splice(index - n,1);
	  }
*/		
	  for (n in nodes){
		for (i in link_categories) {
		  if (link_categories[i].active) {
			  var column = link_categories[i].name;
			  var values = nodes[n][column];
			  for (j in values) {
				var value = values[j];
				console.log(value);
				if (known_connectors[column][value] == undefined) {
					known_connectors[column][value] = nodes.length;
					var new_node = {"label":value,
									"type":column,
									"color":link_categories[i].color,
									"id":nodes.length
					};
					nodes.push(new_node);
				}
				var new_edge = {"source":parseInt(n),
								"target":parseInt(known_connectors[column][value]),
								"value":parseInt(1)        	        	
				};
				console.log(dynamic_links.push(new_edge));
			  }
		  }
		}
	  }
	
	  force
		  .nodes(nodes)
		  .links(dynamic_links);	
      force.start()

	  var link_updates = svg.selectAll("line.link")
		  .data(dynamic_links, function(d) {return d.source.label+"_"+d.target.label});
	  link_updates.exit().remove();
	  var links = link_updates
		.enter().append("line")
		  .attr("class", "link")
		  .style("stroke-width", function(d) { return Math.sqrt(d.value); });
		
	  var node_updates = svg.selectAll(".node")
		.data(nodes, function(d) {return d.label});
	  node_updates.exit().remove();
	  var nodes = node_updates
		.enter().append("g")
		.attr("class", "node")
		.call(force.drag)
		.on("mousedown", function(d) { d.fixed = true; d3.select(this).select("circle").style("stroke", "black").style("stroke-width","4"); })
		.on("dblclick", function(d) { d.fixed = false;d3.select(this).select("circle").style("stroke", "white").style("stroke-width","2") });	
	  nodes.append("circle")
		.attr("r", 6)
		.style("fill", function(d) { return d.color || "#1f77b4"; });	
	  nodes.append("title")
		.attr("dx", 8)
		.attr("dy", ".31em")
		.text(function(d) { return JSON.stringify(d) });	
      nodes.append("text")
        .attr("x", 8)
        .attr("y", ".31em")
        .attr("class", "shadow")
        .text(function(d) { return d.label; });
	  nodes.append("text")
		.attr("dx", 8)
		.attr("dy", ".31em")
		.text(function(d) { return d.label });	

	  force.on("tick", function() {
		svg.selectAll("line.link").attr("x1", function(d) { return d.source.x; })
			 .attr("y1", function(d) { return d.source.y; })
			 .attr("x2", function(d) { return d.target.x; })
			 .attr("y2", function(d) { return d.target.y; });						
		svg.selectAll(".node").attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; }); 	
	  });

}


function getData() {	//Only working with one collection in this tool
	var c = window.exhibit.getDefaultCollection();
	//gets the ids of the facted data
	var items = c.getRestrictedItems()._hash;				
 
	//get the acutal data objects
	var db = window.exhibit.getDatabase()._spo;
	var newDataObject = [];
	//build facted data object
	for (aItem in items){
	  newDataObject.push(db[aItem]);
	}					  
 
	return newDataObject
}

function setup() {
  if (typeof window.exhibit == 'undefined'){
    eTimeout = setTimeout("setup()",250);
  } else {
    console.log("ready")
//    console.log(getData());
	var l_column_width = $("#search-box").offset().left - 10;    
	console.log(l_column_width);
	$(".networkView").width(l_column_width);
	$("svg").attr("width",l_column_width);
	$("svg").attr("height",l_column_width);
	$(".legend-container").width(l_column_width);
    var c = window.exhibit.getDefaultCollection();
    c.addListener({
        onItemsChanged: function() {
        //console.log(getData());
        //        updateGraph();
          if ($(".networkView").css("display") == "block") {
            draw();
          }
        },
        onRootItemsChanged: function() {
        //console.log(getData());
        //        updateGraph();
          if ($(".networkView").css("display") == "block") {
            draw();
          }
        }
    });
    $("#select-view").on("click","span",function(event){
        console.log($(".exhibit-tileView-body").css("display"));
        if (event.target.id == "select-list") {          
            $(".exhibit-viewPanel").show()
            $(".networkView").hide();
        }
        else if (event.target.id == "select-network") {
            $(".exhibit-viewPanel").hide();
//          $(".networkView").remove();
//     	  $(".exhibit-tileView-body").after("<svg class='networkView' style='display:none; width:620px; height:620px;'></svg>");
            $(".networkView").show();
            draw();
        }
    });
    $("body").on("click",".title-link",function(event){
        var url = $(this).attr("href");
        var seconds = 0;
        console.log(url);
        $("audio#main-player").attr("src",url);
        $("audio#main-player").attr("onloadeddata","console.log('onloaded');console.log(new Date().getTime() / 1000);console.log(this.duration);this.currentTime = "+seconds+";");
        $("audio#main-player").attr("oncanplaythrough","console.log('canplaythrough');console.log(new Date().getTime() / 1000);console.log(this.duration);this.play();");
        return false;
    });
    $(".legend").on("click",function(e){
        console.log(event.target.id);
        for (n in link_categories) {
          if (link_categories[n].name == this.id) {
            link_categories[n].active = !link_categories[n].active;
            console.log(link_categories[n]);
            if (link_categories[n].active) {
                $(this).css("color",link_categories[n].color);
            }
            else {
                $(this).css("color","gray");
            }
          }
        }
        draw();    
    });
  }
}

$(document).ready(function(){
    setup();
    $(window).resize(function() {
	    var l_column_width = $("#search-box").offset().left - 10;    
	    console.log(l_column_width);
	    $(".networkView").width(l_column_width);
	    $("svg").attr("width",l_column_width);
	    $("svg").attr("height",l_column_width);
	    $(".legend-container").width(l_column_width);

    });
});

</script>
  <link rel="exhibit/data" 
       type="application/jsonp"
       href="http://spreadsheets.google.com/feeds/list/0AmC3h3hWs3uTdHJmd2Z0MWlOdDEtNHdLV2UxV1pJbFE/od6/public/basic?alt=json-in-script"
      
       ex:converter="googleSpreadsheets" />

 <link href="music-schema.js" type="application/json" rel="exhibit/data" />



<style type="text/css">
body {font-family: Helvetica, sans-serif;}


a.title-link {color:black;text-decoration:none;}
a.title-link:hover {color:blue}
ol.exhibit-tileView-body {
	list-style: none;
}
ol.exhibit-tileView-body li {
    margin-bottom:2px;
}

a.exhibit-facet-value-link {font-size:.9em;}
div.programnote {
	font-size:.8em;	
	padding-left:10px;

}
div.annotations {
    font-size:.8em;
    padding-left:10px;    
}

div.programnote a, div.programnote a:visited div.annotations a, div.annotations a:visited{
	color:grey; text-decoration: underline;
}

div.compositionmeta {
font-size: .7em;color:grey;
-moz-column-count:2; /* Firefox */
-webkit-column-count:2; /* Safari and Chrome */
column-count:2;
margin-top:2px;
margin-bottom:2px;
padding-left:10px;

}

.black, .black a {color:black;}

audio#main-player {width:100%;display:block; position:fixed;bottom:0px;}

h5 {font-style:normal;
	line-height: 100%;
	margin-bottom:0;
	font-weight:normal;
	border-top: 3px double gray;
}

div.exhibit-collectionView-body {
	width:600px;
}

circle {
  stroke: #fff;
  stroke-width: 1.5px;
}

.link {
  stroke: #999;
  strokw-width:3px;

}
div.networkView {
  position:absolute;
  top: 48px;
  left: 0px;
}
text {
  pointer-events: none;
  font: 10px sans-serif;
  color:black;
  fill:black;
}

text.shadow {
  stroke: #fff;
  stroke-width: 3px;
  stroke-opacity: .8;
}

/* fixes for Safari scrollbars in Lion and Mountain Lion */

::-webkit-scrollbar:vertical {
    width: 4px;
}

::-webkit-scrollbar-track:vertical {
  visibility:visible; 
}

::-webkit-scrollbar-thumb:vertical {
    border-radius: 4px;
    background: rgba(0,0,0,0.5);
}


ul, ol {padding-left:0;}
span#select-list {text-decoration:underline;color:blue;}
span#select-network {text-decoration:underline;color:blue;}



div.exhibit-flowingFacet-body {
	border:1px solid #ddd;
	
}


</style>




</head>
<body>
 
<div id='select-view'>View as <span id='select-list'>List</span> | <span id='select-network'>Network</span> </div>
<div class='networkView' style='display:none;'>
<svg></svg> 
<h5 class="legend-container">Drag a node to fix it in space. Double-click to release. 
<p>Legend: 
<span style="color:#1f77b4;">Compositions</span>, 
<span class="legend" style="color:#ff7f0e;" id="style">Style</span>, 
<span class="legend" style="color:#2ca02c;" id="topos">Topoi</span>, 
<span class="legend" style="color:#d62728;" id="slwork">Sounds Like</span>, 
<span class="legend" style="color:#9467bd" id="cites">Cites</span> [click to toggle]</h5> 
</div>
<table style="table-layout: fixed;min-width:1020px;width:100%;">
<tr>
<td rowspan="2" style="vertical-align:top;min-width:600px;width:100%;">
<ul ex:role="viewPanel">

    <div ex:role="view" ex:showToolbox="true" ex:showSummary="true" ex:orders=".composer" ex:directions="ascending" ex:possibleOrders=".date, .composer" ex:showAll="false" ex:grouped="false" ex:abbreviatedCount="50"></div>
    <div ex:role="lens" ex:onshow="$.expander.defaults.slicePoint = 250;$(this).find('span.note-content').expander();">
    <a class="title-link" ex:href-subcontent="http://sethsem.uchicago.edu/~spb/1989/{{.mp3}}"><h3 ex:content=".label" style="font-family:serif;font-size:1.1em;font-weight:normal;font-style:italic;margin:0;display:inline;"></h3> -
  <span ex:content=".composer" style="font-size:1.1em;font-family:serif;"></span> <span ex:content="if(exists(.year), .year, 'Unknown')"> </span></a>
    <div class="compositionmeta">
    <div ex:if-exists=".genre"><b>Genre:</b> <span ex:content=".genre" ></span>    </div>
    <div ex:if-exists=".style"  ><b>Style:</b> <span ex:content=".style" ></span>    </div>
    <div ex:if-exists=".topos"  ><b>Topoi:</b> <span ex:content=".topos" ></span>    </div>
    <div ex:if-exists=".slwork" ><b>Sounds Like:</b> <span ex:content=".slwork" ></span>    </div>
    <div ex:if-exists=".cites"  ><b>Cites:</b> <span ex:content=".cites" ></span>    </div>
    </div>
    <div ex:if-exists=".programnote" class="programnote" id=""> <b>Program Notes:  </b><span class="note-content" ex:content=".programnote" ></span>    </div>
    <div ex:if-exists=".annotations" class="annotations" id=""> <p><b>Annotations:  </b><span ex:content=".annotations"></span></p></div>

    </div>

</ul>


</td>
<td colspan="2" style="width:400px;">
<div id="search-box">
<table style="width:100%;border-bottom:1px dotted grey;">
<tr>
 <td ex:role="facet" ex:facetLabel="Search Titles" style="width:33%;padding-right:8px;"ex:facetClass="TextSearch" ex:expressions=".label"></td>
 <td ex:role="facet" ex:facetLabel="Search Notes" style="width:33%;padding-right:8px;" ex:facetClass="TextSearch" ex:expressions=".programnote"></td>
  <td ex:role="facet" ex:facetLabel="Search All" style="width:33%;"ex:facetClass="TextSearch"></td>
</tr>
</table>
</div>
</td></tr>
<tr>
<td style="vertical-align:top;width:200px;">


  


   </div>
   <div style="border:1px solid black;">
	<div ex:role="facet" ex:expression=".composer" ex:scroll="true" ex:showMissing="false" ex:facetLabel="Composer" ex:sortMode="count" style="margin:2px;"></div>
	
	
	<table style="width:100%;"><tr>
	<td style="width:100px;vertical-align:top;">
	<div ex:role="facet" ex:expression=".nation" ex:scroll="true" ex:showMissing="false" ex:facetLabel="Nationality" ex:sortMode="count" style="margin:2px;font-size:.8em;"></div>
	</td>
	<td style="width:100px;vertical-align:top;">
	<div ex:role="facet" ex:expression=".eu" ex:scroll="false" ex:showMissing="false" ex:facetLabel="EU?" style="font-size:.8em;" ></div>
	<div ex:role="facet" ex:expression=".mf" ex:scroll="false" ex:showMissing="false" ex:facetLabel="Gender" style="font-size:.8em;"  ></div>
	</td>	
	</tr>
	</table>
	
   </div>
	 	<div ex:role="facet" ex:expression=".style" ex:scroll="true" ex:showMissing="false" ex:facetLabel="Style" ex:sortMode="count" ></div>	     
	     
	 <div ex:role="facet" ex:expression=".topos" ex:scroll="true" ex:showMissing="false" ex:facetLabel="Topos" ex:sortMode="count" ></div>	   

</td>
<td  style="vertical-align:top;width:200px;">

    	<div ex:role="facet" ex:expression=".genre" ex:scroll="true" ex:showMissing="false" ex:facetLabel="Genre" ex:sortMode="count" ></div>   
  
	<div ex:role="facet" ex:expression=".slwork" ex:scroll="true" ex:showMissing="false" ex:facetLabel="Sounds Like (work)" ex:sortMode="count" ></div> 
		  	<div ex:role="facet" ex:expression=".cites" ex:scroll="true" ex:showMissing="false" ex:facetLabel="Cites" ex:sortMode="count" ></div>
	
	
	<div ex:role="facet" ex:expression=".premierenation" ex:scroll="true" ex:showMissing="false" ex:facetLabel="Premiere Location" ex:sortMode="count" ></div>	 	  
	    
		 

</td>
</tr>
</table>



 </body>
<audio id="main-player" controls="controls"></audio>


</html>
